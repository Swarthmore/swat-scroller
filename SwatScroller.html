<html>
<head>
<link href='http://fonts.googleapis.com/css?family=Droid+Sans+Mono' rel='stylesheet' type='text/css'>
</head>
<body>
<canvas id='canvas' width='1024' height='768'></canvas>

<script type='text/javascript'>

var SCREEN_WIDTH = 1024;
var SCREEN_HEIGHT = 768;


var PLAYER_WIDTH = 50;
var PLAYER_HEIGHT = 100;


var DESK_WIDTH = 150;
var DESK_HEIGHT = 150;

var COMPUTER_SCREEN_WIDTH = 600;
var COMPUTER_SCREEN_HEIGHT = 300;

var PANIC_WIDTH = 400;
var PANIC_HEIGHT = 130;

var NUMBER_OF_WORKERS = 6;
var WORKER_SPACING = 300;  // in pixels

var pressed = {};
var sprite = new Image();
sprite.src = "nick-sprite.png";
var dir = 1;			// Player direction
var playerAnim = {};	// Player animation setting

var tick = 0;
var camera = 0; 				// declare the camera

var ground = 0.82*SCREEN_HEIGHT;

var player = new Box(SCREEN_WIDTH/2 - PLAYER_WIDTH/2,ground-PLAYER_HEIGHT,PLAYER_WIDTH,PLAYER_HEIGHT);
var player_desk = new Box(Math.floor(SCREEN_WIDTH*0.05),Math.floor(ground-DESK_HEIGHT),DESK_WIDTH,DESK_HEIGHT);
var computer_screen = new Box(Math.floor(SCREEN_WIDTH*0.01), Math.floor(SCREEN_HEIGHT*0.05), COMPUTER_SCREEN_WIDTH,COMPUTER_SCREEN_HEIGHT);

var panic_mode = false;
var panic_button_pressed = false;

var effects = [];
var ctx = document.getElementById('canvas').getContext('2d');

this.comp_screen_canvas = document.createElement('canvas');
this.comp_screen_Ctx = this.comp_screen_canvas.getContext('2d');
this.comp_screen_canvas.width = COMPUTER_SCREEN_WIDTH;
this.comp_screen_canvas.height = COMPUTER_SCREEN_HEIGHT;

var terminal_listing = [];
var MAX_TERMINAL_LISTING = 15;
var domain_names = ["facebook.com","youtube.com","yahoo.com","live.com","msn.com","wikipedia.org","blogspot.com","baidu.com","microsoft.com","qq.com","bing.com","ask.com","adobe.com","taobao.com","twitter.com","youku.com","soso.com","wordpress.com","sohu.com","hao123.com","windows.com","163.com","tudou.com","amazon.com","apple.com","ebay.com","4399.com","yahoo.co.jp","linkedin.com","go.com","tmall.com","paypal.com","sogou.com","ifeng.com","aol.com","xunlei.com","craigslist.org","orkut.com","56.com","orkut.com.br","about.com","skype.com","7k7k.com","dailymotion.com","flickr.com","pps.tv","qiyi.com","bbc.co.uk","4shared.com","mozilla.com","ku6.com","imdb.com","cnet.com","babylon.com","mywebsearch.com","alibaba.com","mail.ru","uol.com.br","badoo.com","cnn.com","myspace.com","netflix.com","weather.com","soku.com","weibo.com","renren.com","rakuten.co.jp","17kuxun.com","yandex.ru","booking.com","ehow.com","bankofamerica.com","58.com","zedo.com","2345.com","globo.com","mapquest.com","goo.ne.jp","answers.com","360.cn","chase.com","naver.com","hp.com","odnoklassniki.ru","alipay.com","huffingtonpost.com","ameblo.jp","ganji.com","alot.com","scribd.com","megaupload.com","tumblr.com","softonic.com","camzap.com","vkontakte.ru","avg.com","walmart.com","pptv.com","xinhuanet.com","mediafire.com"];






//at the top
var skyline1 = [];
for(var i=0; i<100; i++) {
    skyline1[i] = rand(50,200);
}
var skyline2 = [];
for(var i=0; i<200; i++) {
    skyline2[i] = rand(50,200);
}
var skyline3 = [];
for(var i=0; i<300; i++) {
    skyline3[i] = rand(50,300);
}

// Generate workers
var workers = [];
for(var i=0; i<NUMBER_OF_WORKERS; i++) {
	workers[i] = new Box(1.5*SCREEN_WIDTH + i*WORKER_SPACING, Math.floor(ground-DESK_HEIGHT),DESK_WIDTH,DESK_HEIGHT);
}





function setup() {

	player.dy = 0;

	// Set up idle animation
	playerAnim.idle = [];
    for(var i=0; i<4; i++) {
        playerAnim.idle.push({x:i*64, y:0});
    }

	playerAnim.walking = [];
    for(var i=0; i<8; i++) {
        playerAnim.walking.push({x:i*64, y:64});
    }
    playerAnim.jumping = [];
    for(var i=0; i<8; i++) {
        playerAnim.jumping.push({x:i*64, y:64});
    }


	playerAnim.index = 0;
    playerAnim.name = "idle";

    document.addEventListener('keydown',function(e) { 
        pressed[e.keyCode] = true;   
    });
    document.addEventListener('keyup',  function(e) {  
        pressed[e.keyCode] = false;  
    });
}






function gameLoop() {
    processInput();
    updateGameState();
    checkConditions();
	processAnimations();
    draw();
    window.requestAnimFrame(gameLoop);
}




function processInput() {
}


function updateGameState() {

	playerAnim.name = "idle";
	playerAnim.dir = 1
	
    if(pressed['A'.charCodeAt(0)] == true) {
        player.x -= 4;
        playerAnim.name = "walking";
        playerAnim.dir = -1;
    }
    if(pressed['S'.charCodeAt(0)] == true) {
        player.x += 4;
        playerAnim.name = "walking";
    }
 
     if(pressed['P'.charCodeAt(0)] == true) {
        // If the panic mode button was just pressed, toggle panic mode
        if (!panic_button_pressed) {
        	panic_mode = !panic_mode;
        }
        panic_button_pressed = true;
    } else {
    	panic_button_pressed = false;
    }
 
 
    /*
    if(pressed[' '.charCodeAt(0)] == true) {
        if( !jumping && player.getBottom() >= ground) {
            player.dy -= 25  ;
            jumping = true;
        }
    } else {
        jumping = false;
    }    
    
    if(player.getBottom() <= ground) {
        playerAnim.name = "jumping";
    }   

    
    player.y += player.dy;
    player.dy += 1;
	 */
 
    camera = player.x - Math.floor(SCREEN_WIDTH/2); // update the camera
    
    
}

function checkConditions() {


	/*
    if(player.intersects(player_desk)) {
        console.log("player hit the player_desk.");
        
        var effect = new ParticleEffect();
        effect.x = player.x;
        effect.y = 400-player.h/2;
        effect.max = 100;
        effect.initParticle = function(part) {
            part.dy = rand(-5,5);
            part.dx = rand(-3,0);
            part.color = randColor();
            return part;
        };
        effects.push(effect);
        player.x = 0;
    }
    */
    
    
    // Clean up old effects
	for (var i=0; i < effects.length; i++)
	{
        if (effects[i].age > effects[i].maxage) {
        	effects.splice(i, 1);	
        }
    }
    
    // Check to see if player hits the ground
    if(player.getBottom() > ground) {
    	player.dy = 0;
    	player.setBottom(ground);
	}
    
    
    
}

function processAnimations() {

	// Every 6th tick, switch to next sprite for current animation
    tick++;
    if(tick % 6 == 0) {
        playerAnim.index++;
    }
    if(playerAnim.index >= playerAnim[playerAnim.name].length) {
        playerAnim.index = 0;
    }
    
    // Scroll terminal window if not in panic mode
    // by adding a new line
    if (!panic_mode && (tick % 10 == 0)) {
    	var domain_index = Math.floor(rand(0, domain_names.length-1));
    	var domain = domain_names[domain_index];
    	
    	var ip = Math.floor(rand(0,255)) + "." + Math.floor(rand(0,255)) + "." + Math.floor(rand(0,255)) + "." + Math.floor(rand(0,255));

		terminal_listing.unshift(ip + " - [26/Apr/2000:00:23:48] \"GET\" " + domain + "HTTP/1.0\"");
		//console.log( domain_index, domain, terminal_listing[0])
		if (terminal_listing.length > MAX_TERMINAL_LISTING) {
			terminal_listing.pop()
		}	
    
    	// Draw the computer screen into a secondary canvas
    	draw_computer_screen(comp_screen_Ctx) 
    }
    
    
}

function draw() {
    drawBackground(ctx);
    //drawSkyline(ctx);
    drawGround(ctx);
    ctx.save();
    ctx.translate(-camera,0);

    drawplayer_desk(ctx);
    copy_computer_screen(ctx);
    draw_workers(ctx);
    drawPlayer(ctx);    
    //drawEffects(ctx);
    ctx.restore();
}


function copy_computer_screen(ctx) {
    ctx.drawImage(comp_screen_canvas, 0,0);
}






function drawBackground(ctx) {
    ctx.fillStyle = "#FFFFE0";
    ctx.fillRect(0,0,SCREEN_WIDTH,SCREEN_HEIGHT);
}



function drawGround(ctx) {
    ctx.fillStyle = "#88ff00";
    ctx.fillRect(0,ground,SCREEN_WIDTH,SCREEN_HEIGHT-ground);
}

//new function to draw the skyline
function drawSkyline(ctx) {


    ctx.save();
    ctx.translate(-camera/8, 0);
    ctx.fillStyle = "#222244";
    for(var i in skyline3) {
        var h = skyline3[i];
        ctx.fillRect(i*50/3, ground - h, 51/3, h);
    }
    
    ctx.restore();   


    ctx.save();
    ctx.translate(-camera/4, 0);
    ctx.fillStyle = "#224422";
    for(var i in skyline2) {
        var h = skyline2[i];
        ctx.fillRect(i*25, ground - h, 26, h);
    }
    
    ctx.restore();   




    ctx.save();
    ctx.translate(-camera/2, 0);
    ctx.fillStyle = "#442222";
    for(var i in skyline1) {
        var h = skyline1[i];
        ctx.fillRect(i*50, ground - h, 51, h);
    }
    
    ctx.restore();
    
 
}



function drawPlayer(ctx) {
    
    ctx.save();
	ctx.translate(player.x,player.y);
    var slice = playerAnim[playerAnim.name][playerAnim.index];
    ctx.imageSmoothingEnabled = false;
    ctx.mozImageSmoothingEnabled = false;
    ctx.webkitImageSmoothingEnabled = false;
    ctx.scale(playerAnim.dir, 1);
	ctx.drawImage(sprite,
	    slice.x,slice.y,64,64, //src
	    -64-32,-64-32-20,128*2,128*2 //dst
	    );
   
	ctx.restore();
    
}
function drawplayer_desk(ctx) {
    ctx.fillStyle = "#FF0000";
    player_desk.fillRect(ctx);
}

function draw_computer_screen(ctx) {


	if (!panic_mode)
	{
		ctx.save();
		ctx.fillStyle = "#000000";
		computer_screen.fillRect(ctx);
	
		ctx.rect(computer_screen.x,computer_screen.y,computer_screen.w,computer_screen.h);
		
		ctx.clip();
		ctx.fillStyle = "#00FF00";
		ctx.textAlign = 'left';
		ctx.font="20px 'Droid Sans Mono'";
		
		var count = 0;
		for(var index in terminal_listing) { 
			ctx.fillText(terminal_listing[index],Math.floor(computer_screen.getLeft()*1.1),computer_screen.getBottom()-15-25*count);
			count++;
		}
		console.log(count);
		ctx.restore();
		
		
 	} else {
 	
 	    ctx.fillStyle = "#FF0000";
		computer_screen.fillRect(ctx);
		ctx.textBaseline = 'middle';
		ctx.fillStyle = "#FFFFFF";
		ctx.textAlign = 'center';
		ctx.font="110px Arial";
			ctx.fillText("PANIC!",Math.floor(computer_screen.getLeft()+computer_screen.getRight())/2,Math.floor(computer_screen.getBottom()-computer_screen.getTop())/2+40);
		
 	
 	}
    
    
}


//new function to draw the skyline
function draw_workers(ctx) {
    ctx.fillStyle = "#0000FF";
    for(var i in workers) {
        workers[i].fillRect(ctx);
    }
}  



function drawEffects(ctx) {
    effects.forEach(function(ef) {
        ef.tick();
        ef.draw(ctx);
    });
}



function refresh() {
}




function Box(x,y,w,h) {
    this.x = x;
    this.y = y;
    this.w = w;
    this.h = h;
    this.fillRect = function(ctx) {
        ctx.fillRect(this.x,this.y,this.w,this.h);
    }
    this.getRight = function() { return this.x + this.w; }
    this.getLeft = function() { return this.x; }
    this.getTop = function() { return this.y; }
    this.getBottom = function() { return this.y + this.h; }
    
    this.setRight  = function(right) { this.x = right - this.w; }
    this.setLeft   = function(left)  { this.x = left; }
    this.setBottom = function(bottom) { this.y = bottom - this.h; }
    this.setTop    = function(top) { this.y = top; }
    
    this.intersects = function(box) {
        if(this.getRight() >= box.getLeft() 
        && this.getLeft() <= box.getRight()) {
            if(this.getBottom() >= box.getTop() 
            && this.getTop() <= box.getBottom()) {
                    return true;
            }
  		}	
  		return false;    	
    }
}

function rand(lo,hi) {
    return lo + Math.random()*(hi-lo);
}

function randColor() {
    return '#'+Math.floor(Math.random()*16777215).toString(16);
}

function ParticleEffect() {
    this.x = 0;
    this.y = 0;
    this.age = 0;
    this.parts = [];
    this.rate = 1;
    this.max = 10;
    this.maxage = 200;
    this.color = "#aaaaaa";
    this.alive = true;
    this.initParticle = function(part) {
        return part;
    }
    this.tick = function() {
        this.age++;
        if(this.age > this.maxage) {
            this.alive = false;
            return;
        }
        if((this.age % this.rate) == 0 && this.parts.length < this.max) {
            var part = {
                x:this.x,
                y:this.y,
                dx: rand(-3,3),
                dy: rand(-3,3),
                alpha:1,
                dalpha:-0.01,
                color: this.color,
                };
            this.parts.push(this.initParticle(part));
        }
        for(var i=0; i<this.parts.length; i++) {
            var p = this.parts[i];
            p.y += p.dy;
            p.x += p.dx;
            p.alpha += p.dalpha;
        }
    }
    this.draw = function(g) {
        if(!this.alive) return;
        g.save();
        for(var i=0; i<this.parts.length; i++) {
            var p = this.parts[i];
            if(p.alpha < 0) continue;
            g.fillStyle = p.color;
            g.globalAlpha = p.alpha;
            g.fillRect(p.x,p.y,20,20);
        }
        g.restore();
    }
}

setup();



window.requestAnimFrame = (function(){
  return  window.requestAnimationFrame       ||
          window.webkitRequestAnimationFrame ||
          window.mozRequestAnimationFrame    ||
          function( callback ){
            window.setTimeout(callback, 1000 / 60);
          };
})();

window.requestAnimFrame(gameLoop);

</script>

</body>
</html>
